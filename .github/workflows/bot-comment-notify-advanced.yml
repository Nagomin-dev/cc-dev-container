name: Advanced Bot Comment Notification

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯Slack Bot Tokenã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®é€šçŸ¥ã‚’å®Ÿç¾ã—ã¾ã™
# å¿…è¦ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:
# 1. Slack Appã‚’ä½œæˆã—ã€chat:write, chat:write.publicã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸
# 2. Bot User OAuth Tokenã‚’GitHub Secretsã« SLACK_BOT_TOKEN ã¨ã—ã¦ä¿å­˜
# 3. ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’ç¢ºèªï¼ˆä¾‹: C1234567890ï¼‰

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: read
  pull-requests: read

env:
  # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ï¼‰
  NOTIFY_KEYWORDS: "review,approved,changes requested,vulnerability,error,warning,bug,security"
  IGNORE_KEYWORDS: "WIP,draft,test"
  NOTIFY_CODERABBIT: "true"
  NOTIFY_CLAUDE: "true"
  NOTIFY_OTHER_BOTS: "false"

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Check if should notify
        id: should-notify
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é€šçŸ¥ã—ãªã„
          echo "should_notify=false" >> $GITHUB_OUTPUT

          # ãƒœãƒƒãƒˆã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
          USER_LOGIN="${{ github.event.comment.user.login }}"
          IS_BOT=false
          BOT_TYPE=""

          # CodeRabbitãƒã‚§ãƒƒã‚¯
          if [[ "$USER_LOGIN" =~ coderabbit ]]; then
            IS_BOT=true
            BOT_TYPE="coderabbit"
            if [[ "${{ env.NOTIFY_CODERABBIT }}" == "true" ]]; then
              echo "should_notify=true" >> $GITHUB_OUTPUT
            fi
          # GitHub Actions botï¼ˆClaude Code Actionå«ã‚€ï¼‰ãƒã‚§ãƒƒã‚¯
          elif [[ "$USER_LOGIN" == "github-actions[bot]" ]]; then
            IS_BOT=true
            # Claude Code Actionã‹ã©ã†ã‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‹ã‚‰åˆ¤å®š
            if echo "$COMMENT_BODY" | grep -qiE "(Claude|Anthropic|claude-code-action|Claude Code)"; then
              BOT_TYPE="claude"
              if [[ "${{ env.NOTIFY_CLAUDE }}" == "true" ]]; then
                echo "should_notify=true" >> $GITHUB_OUTPUT
              fi
            else
              BOT_TYPE="other"
              if [[ "${{ env.NOTIFY_OTHER_BOTS }}" == "true" ]]; then
                echo "should_notify=true" >> $GITHUB_OUTPUT
              fi
            fi
          fi

          echo "is_bot=$IS_BOT" >> $GITHUB_OUTPUT
          echo "bot_type=$BOT_TYPE" >> $GITHUB_OUTPUT

          # ãƒœãƒƒãƒˆã§ãªã„å ´åˆã¯å‡¦ç†çµ‚äº†
          if [[ "$IS_BOT" != "true" ]]; then
            exit 0
          fi

          # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          # ç„¡è¦–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
          if [[ -n "${{ env.IGNORE_KEYWORDS }}" ]]; then
            IFS=',' read -ra IGNORE_ARRAY <<< "${{ env.IGNORE_KEYWORDS }}"
            for keyword in "${IGNORE_ARRAY[@]}"; do
              if echo "$COMMENT_BODY" | grep -qi "$keyword"; then
                echo "should_notify=false" >> $GITHUB_OUTPUT
                echo "Ignored due to keyword: $keyword"
                exit 0
              fi
            done
          fi

          # é€šçŸ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
          if [[ -n "${{ env.NOTIFY_KEYWORDS }}" ]]; then
            FOUND_KEYWORD=false
            IFS=',' read -ra NOTIFY_ARRAY <<< "${{ env.NOTIFY_KEYWORDS }}"
            for keyword in "${NOTIFY_ARRAY[@]}"; do
              if echo "$COMMENT_BODY" | grep -qi "$keyword"; then
                FOUND_KEYWORD=true
                echo "matched_keyword=$keyword" >> $GITHUB_OUTPUT
                break
              fi
            done

            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯é€šçŸ¥ã—ãªã„
            if [[ "$FOUND_KEYWORD" != "true" ]]; then
              echo "should_notify=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Set bot info
        if: steps.should-notify.outputs.should_notify == 'true'
        id: bot-info
        run: |
          set -euo pipefail
          BOT_TYPE="${{ steps.should-notify.outputs.bot_type }}"

          case "$BOT_TYPE" in
            "coderabbit")
              echo "bot_name=CodeRabbit" >> $GITHUB_OUTPUT
              echo "bot_icon=ğŸ°" >> $GITHUB_OUTPUT
              echo "bot_color=#FF6B6B" >> $GITHUB_OUTPUT
              ;;
            "claude")
              echo "bot_name=Claude Code Action" >> $GITHUB_OUTPUT
              echo "bot_icon=ğŸ¤–" >> $GITHUB_OUTPUT
              echo "bot_color=#6366F1" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "bot_name=GitHub Actions Bot" >> $GITHUB_OUTPUT
              echo "bot_icon=âš™ï¸" >> $GITHUB_OUTPUT
              echo "bot_color=#808080" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Analyze comment content
        if: steps.should-notify.outputs.should_notify == 'true'
        id: comment-analysis
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          # ã‚³ãƒ¡ãƒ³ãƒˆã®é‡è¦åº¦ã‚’åˆ¤å®š
          IMPORTANCE="normal"
          if echo "$COMMENT_BODY" | grep -qiE "(error|failed|failure|bug|vulnerability|security)"; then
            IMPORTANCE="high"
          elif echo "$COMMENT_BODY" | grep -qiE "(approved|lgtm|success|passed)"; then
            IMPORTANCE="success"
          elif echo "$COMMENT_BODY" | grep -qiE "(warning|suggestion|consider)"; then
            IMPORTANCE="warning"
          fi

          echo "importance=$IMPORTANCE" >> $GITHUB_OUTPUT

          # é‡è¦åº¦ã«å¿œã˜ãŸçµµæ–‡å­—ã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è¨­å®š
          case "$IMPORTANCE" in
            "high")
              echo "importance_icon=ğŸš¨" >> $GITHUB_OUTPUT
              echo "mention=<!channel>" >> $GITHUB_OUTPUT
              ;;
            "success")
              echo "importance_icon=âœ…" >> $GITHUB_OUTPUT
              echo "mention=" >> $GITHUB_OUTPUT
              ;;
            "warning")
              echo "importance_icon=âš ï¸" >> $GITHUB_OUTPUT
              echo "mention=" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "importance_icon=ğŸ“" >> $GITHUB_OUTPUT
              echo "mention=" >> $GITHUB_OUTPUT
              ;;
          esac

          # ã‚³ãƒ¡ãƒ³ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ
          PREVIEW=$(echo "$COMMENT_BODY" | tr '\n' ' ' | cut -c1-500)
          if [ ${#COMMENT_BODY} -gt 500 ]; then
            PREVIEW="${PREVIEW}..."
          fi
          echo "preview<<EOF" >> $GITHUB_OUTPUT
          echo "$PREVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set Slack channel
        if: steps.should-notify.outputs.should_notify == 'true'
        id: slack-channel
        run: |
          set -euo pipefail
          # ãƒ–ãƒ©ãƒ³ãƒã‚„ãƒ©ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ±ºå®š
          # Bot Tokenæ–¹å¼ã§ã¯ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’ä½¿ç”¨ï¼ˆç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼‰
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ£ãƒ³ãƒãƒ«IDï¼ˆä¾‹: C1234567890ï¼‰
          CHANNEL="${{ vars.SLACK_CHANNEL_GITHUB_NOTIFICATIONS || 'C1234567890' }}"

          # PRã®å ´åˆã€GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          if [[ -n "${{ github.event.issue.pull_request.url || '' }}" ]]; then
            PR_URL="${{ github.event.issue.pull_request.url }}"
            echo "Fetching PR details from: $PR_URL"

            # GitHub APIã§PRæƒ…å ±ã‚’å–å¾—
            PR_DATA=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
                           -H "Accept: application/vnd.github.v3+json" \
                           "$PR_URL")

            # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’æŠ½å‡º
            BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref // empty')
            echo "Base branch: $BASE_REF"

            if [[ "$BASE_REF" == "main" ]]; then
              CHANNEL="${{ vars.SLACK_CHANNEL_PRODUCTION_ALERTS || 'C0987654321' }}"
            fi
          fi

          # ãƒ©ãƒ™ãƒ«ã®ç¢ºèªï¼ˆjqã‚’ä½¿ç”¨ï¼‰
          LABELS=$(jq -r '.issue.labels[]?.name // empty' "$GITHUB_EVENT_PATH" 2>/dev/null | tr '\n' ' ' || echo "")
          if [[ "$LABELS" =~ "urgent" ]]; then
            CHANNEL="${{ vars.SLACK_CHANNEL_URGENT_NOTIFICATIONS || 'C1122334455' }}"
          elif [[ "$LABELS" =~ "security" ]]; then
            CHANNEL="${{ vars.SLACK_CHANNEL_SECURITY_ALERTS || 'C5566778899' }}"
          fi

          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.should-notify.outputs.should_notify == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          # Bot Tokenæ–¹å¼ã§ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‹•çš„ã«æŒ‡å®š
          channel-id: ${{ steps.slack-channel.outputs.channel }}
          payload: |
            {
              "text": "${{ steps.comment-analysis.outputs.importance_icon }} ${{ steps.bot-info.outputs.bot_icon }} ${{ steps.bot-info.outputs.bot_name }} commented on ${{ github.event.issue.pull_request && 'PR' || 'Issue' }} #${{ github.event.issue.number }} ${{ steps.comment-analysis.outputs.mention }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ steps.comment-analysis.outputs.importance_icon }} ${{ steps.bot-info.outputs.bot_icon }} ${{ steps.bot-info.outputs.bot_name }} ãŒã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ* ${{ steps.comment-analysis.outputs.mention }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "é‡è¦åº¦: ${{ steps.comment-analysis.outputs.importance }} | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${{ steps.should-notify.outputs.matched_keyword || 'ãªã—' }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒã‚¸ãƒˆãƒª:*\n`${{ github.repository }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*${{ github.event.issue.pull_request && 'ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ' || 'ã‚¤ã‚·ãƒ¥ãƒ¼' }}:*\n<${{ github.event.issue.html_url }}|#${{ github.event.issue.number }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ã‚¿ã‚¤ãƒˆãƒ«:*\n${{ github.event.issue.title }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ä½œæˆè€…:*\n${{ github.event.issue.user.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒœãƒƒãƒˆ:*\n`${{ github.event.comment.user.login }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*æ—¥æ™‚:*\n<!date^${{ github.event.comment.created_at }}^{date_short_pretty} {time}|${{ github.event.comment.created_at }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹:*\n```${{ steps.comment-analysis.outputs.preview }}```"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ ğŸ‘€",
                        "emoji": true
                      },
                      "url": "${{ github.event.comment.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ github.event.issue.pull_request && 'PR' || 'Issue' }}ã‚’é–‹ã ğŸ“„",
                        "emoji": true
                      },
                      "url": "${{ github.event.issue.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ãƒªãƒã‚¸ãƒˆãƒª ğŸ“",
                        "emoji": true
                      },
                      "url": "${{ github.event.repository.html_url }}"
                    }
                  ]
                }
              ],
              "attachments": [
                {
                  "color": "${{ steps.bot-info.outputs.bot_color }}",
                  "footer": "GitHub Bot Comment Notifier",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "ts": "${{ github.event.comment.created_at }}"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
