name: Bot Comment Notification

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯Slack Bot Tokenã‚’ä½¿ç”¨ã—ã¦é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™
# Webhook URLãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ç§»è¡Œã™ã‚‹å ´åˆ:
# 1. Slack Appã‚’ä½œæˆã—ã€chat:write, chat:write.publicã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸
# 2. Bot User OAuth Tokenã‚’GitHub Secretsã« SLACK_BOT_TOKEN ã¨ã—ã¦ä¿å­˜
# 3. ç’°å¢ƒå¤‰æ•°ã§ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’è¨­å®šï¼ˆSLACK_CHANNEL_IDï¼‰

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: read
  pull-requests: read

env:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Slackãƒãƒ£ãƒ³ãƒãƒ«IDï¼ˆç’°å¢ƒå¤‰æ•°ã¾ãŸã¯GitHub Variables ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
  SLACK_CHANNEL_ID: ${{ vars.SLACK_CHANNEL_ID || 'C1234567890' }}

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    # PRã¾ãŸã¯Issueã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã§ã€CodeRabbitã¾ãŸã¯GitHub Actionsãƒœãƒƒãƒˆã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
    if: |
      (github.event.issue.pull_request || github.event.issue) &&
      (contains(github.event.comment.user.login, 'coderabbit') ||
       github.event.comment.user.login == 'github-actions[bot]')

    steps:
      - name: Determine bot type
        id: bot-type
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          # ãƒœãƒƒãƒˆã®ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
          if [[ "${{ github.event.comment.user.login }}" == "github-actions[bot]" ]]; then
            # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‹ã‚‰Claude Code Actionã‹ã©ã†ã‹ã‚’åˆ¤å®š
            if echo "$COMMENT_BODY" | grep -qiE "(Claude|Anthropic|claude-code-action)"; then
              echo "bot_name=Claude Code Action" >> $GITHUB_OUTPUT
              echo "bot_icon=ğŸ¤–" >> $GITHUB_OUTPUT
              echo "bot_color=#6366F1" >> $GITHUB_OUTPUT
            else
              echo "bot_name=GitHub Actions Bot" >> $GITHUB_OUTPUT
              echo "bot_icon=âš™ï¸" >> $GITHUB_OUTPUT
              echo "bot_color=#808080" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event.comment.user.login }}" =~ "coderabbit" ]]; then
            echo "bot_name=CodeRabbit" >> $GITHUB_OUTPUT
            echo "bot_icon=ğŸ°" >> $GITHUB_OUTPUT
            echo "bot_color=#FF6B6B" >> $GITHUB_OUTPUT
          else
            echo "bot_name=Unknown Bot" >> $GITHUB_OUTPUT
            echo "bot_icon=ğŸ¤·" >> $GITHUB_OUTPUT
            echo "bot_color=#808080" >> $GITHUB_OUTPUT
          fi

      - name: Extract comment preview
        id: comment-preview
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          set -euo pipefail
          # ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®500æ–‡å­—ã‚’æŠ½å‡ºï¼ˆSlackè¡¨ç¤ºç”¨ï¼‰
          # æ”¹è¡Œã‚’ç©ºç™½ã«å¤‰æ›ã—ã€500æ–‡å­—ã«åˆ¶é™
          PREVIEW=$(echo "$COMMENT_BODY" | tr '\n' ' ' | cut -c1-500)
          if [ ${#COMMENT_BODY} -gt 500 ]; then
            PREVIEW="${PREVIEW}..."
          fi
          # GitHub Outputã«å®‰å…¨ã«å‡ºåŠ›ã™ã‚‹ãŸã‚ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          echo "preview<<EOF" >> $GITHUB_OUTPUT
          echo "$PREVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "${{ steps.bot-type.outputs.bot_icon }} ${{ steps.bot-type.outputs.bot_name }} commented on ${{ github.event.issue.pull_request && 'PR' || 'Issue' }} #${{ github.event.issue.number }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ steps.bot-type.outputs.bot_icon }} ${{ steps.bot-type.outputs.bot_name }} ãŒã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒã‚¸ãƒˆãƒª:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*${{ github.event.issue.pull_request && 'ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ' || 'ã‚¤ã‚·ãƒ¥ãƒ¼' }}:*\n<${{ github.event.issue.html_url }}|#${{ github.event.issue.number }} ${{ github.event.issue.title }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒœãƒƒãƒˆ:*\n`${{ github.event.comment.user.login }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ä½œæˆæ—¥æ™‚:*\n${{ github.event.comment.created_at }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹:*\n```${{ steps.comment-preview.outputs.preview }}```"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹",
                        "emoji": true
                      },
                      "url": "${{ github.event.comment.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ github.event.issue.pull_request && 'PR' || 'Issue' }}ã‚’é–‹ã",
                        "emoji": true
                      },
                      "url": "${{ github.event.issue.html_url }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "${{ github.event.repository.full_name }} â€¢ ${{ github.event.comment.author_association }}"
                    }
                  ]
                }
              ],
              "attachments": [
                {
                  "color": "${{ steps.bot-type.outputs.bot_color }}",
                  "footer": "GitHub Actions Bot Comment Notifier",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "ts": "${{ github.event.comment.created_at }}"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
